@model ProjeOdeviWeb_G231210048.Models.Appointment

@{
    ViewData["Title"] = "Randevu Düzenle";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow border-0">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="fa-solid fa-pen-to-square"></i> Randevu Düzenle</h4>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Edit">
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <input type="hidden" asp-for="Id" />

                        <input type="hidden" asp-for="AppUserId" />
                        <input type="hidden" asp-for="Status" value="Onay Bekliyor" />

                        <div class="mb-3">
                            <label class="form-label fw-bold">Üye</label>
                            <input type="text" class="form-control bg-light" value="@User.Identity.Name" disabled readonly />
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="ServiceId" class="form-label fw-bold">Hizmet</label>
                                <select asp-for="ServiceId" class="form-select" asp-items="ViewBag.ServiceId"></select>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="TrainerId" class="form-label fw-bold">Eğitmen</label>
                                <select asp-for="TrainerId" class="form-select" asp-items="ViewBag.TrainerId" id="trainerSelect"></select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label asp-for="Date" class="form-label fw-bold">Tarih</label>
                                <input asp-for="Date" type="date" class="form-control" />
                                <span asp-validation-for="Date" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Süre</label>
                                <select asp-for="Duration" class="form-select" id="durationSelect">
                                    <option value="60">60 Dakika</option>
                                    <option value="30">30 Dakika</option>
                                    <option value="90">90 Dakika</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Time" class="form-label fw-bold">Uygun Saat Aralığı</label>
                            <select asp-for="Time" class="form-select" id="timeSelect">
                            </select>
                            <div class="form-text text-muted" id="workingHoursInfo"></div>
                        </div>

                        <div class="alert alert-info d-flex align-items-center" role="alert">
                            <i class="fa-solid fa-circle-info me-2"></i>
                            <div>
                                <strong>Bilgi:</strong> Randevuyu düzenlediğinizde durumu otomatik olarak <u>Onay Bekliyor</u> şeklinde güncellenecektir.
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Değişiklikleri Kaydet</button>
                            <a asp-action="Index" class="btn btn-secondary">Listeye Dön</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {
            // Değişkenler
            let trainerStart = "09:00";
            let trainerEnd = "17:00";

            // Mevcut randevu saati (Razor'dan alıyoruz)
            // Model.Time TimeSpan olduğu için "hh:mm" formatına çeviriyoruz
            let currentSelectedTime = "@Model.Time.ToString(@"hh\:mm")";

            // SAYFA YÜKLENDİĞİNDE: Mevcut hocanın saatlerini getir
            var initialTrainerId = $('#trainerSelect').val();
            if (initialTrainerId) {
                updateTrainerHours(initialTrainerId);
            }

            // 1. Antrenör Değişince
            $('#trainerSelect').change(function () {
                var trainerId = $(this).val();
                if (trainerId) {
                    updateTrainerHours(trainerId);
                }
            });

            // 2. Süre Değişince
            $('#durationSelect').change(function () {
                generateTimeSlots();
            });

            // FONKSİYON: Hocanın saatlerini API'den çek
            function updateTrainerHours(trainerId) {
                $.get('/Appointments/GetTrainerHours', { trainerId: trainerId }, function (data) {
                    trainerStart = data.start;
                    trainerEnd = data.end;

                    $('#workingHoursInfo').text(`Seçilen eğitmen ${trainerStart} - ${trainerEnd} saatleri arasında çalışmaktadır.`);

                    // Saatleri oluştur
                    generateTimeSlots();
                });
            }

            // FONKSİYON: Saatleri oluştur (Create sayfasındaki mantığın aynısı)
            function generateTimeSlots() {
                let duration = parseInt($('#durationSelect').val());
                let select = $('#timeSelect');

                // Mevcut seçili değeri sakla (Eğer listede varsa tekrar seçmek için)
                // İlk yüklemede Razor'dan gelen değeri kullan, sonrakilerde kullanıcının seçtiğini
                let selectedVal = select.val() || currentSelectedTime;

                select.empty();

                let startParts = trainerStart.split(':');
                let endParts = trainerEnd.split(':');
                let startMin = parseInt(startParts[0]) * 60 + parseInt(startParts[1]);
                let endMin = parseInt(endParts[0]) * 60 + parseInt(endParts[1]);

                for (let time = startMin; time < endMin; time += 30) {
                    if (time + duration > endMin) continue;

                    let h = Math.floor(time / 60);
                    let m = time % 60;
                    let timeString = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;

                    let option = $('<option></option>').val(timeString).text(timeString + ` (Bitiş: ${addMinutes(timeString, duration)})`);

                    // Eğer bu saat, mevcut randevu saatiyse SEÇİLİ yap
                    if (timeString === selectedVal) {
                        option.prop('selected', true);
                    }

                    select.append(option);
                }
            }

            function addMinutes(timeStr, minsToAdd) {
                let parts = timeStr.split(':');
                let totalMin = parseInt(parts[0]) * 60 + parseInt(parts[1]) + minsToAdd;
                let h = Math.floor(totalMin / 60);
                let m = totalMin % 60;
                return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
            }
        });
    </script>
}